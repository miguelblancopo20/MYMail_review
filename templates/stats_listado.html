{% extends "base.html" %}
{% block body %}
  <header class="topbar">
    <div class="topbar-left">
      <a class="topbar-brand" href="{{ url_for('menu') }}">
        <img class="topbar-logo" alt="EY logo" src="{{ url_for('static', filename='img/ey.png') }}" onerror="this.style.display='none'" />
        <div class="topbar-title">Revisor de Mayordomo Mail <span class="version-badge">v{{ app_version }}</span></div>
      </a>
    </div>
    <div class="topbar-fields">
      <div class="topbar-field"><span>Vista</span><strong>Listado</strong></div>
    </div>
    <div class="topbar-right">
      <a class="btn btn-ghost btn-sm btn-nav" href="{{ url_for('listado') }}">Listado</a>
      <a class="btn btn-ghost btn-sm btn-nav" href="{{ url_for('pendientes') }}">Pendientes</a>
      <a class="btn btn-ghost btn-sm btn-nav" href="{{ url_for('review') }}">Revisi&oacute;n</a>
      <a class="btn btn-ghost btn-sm btn-nav" href="{{ url_for('stats') }}">Estad&iacute;sticas</a>
      <a class="btn btn-ghost btn-sm btn-nav" href="{{ url_for('stats_my') }}">Estad&iacute;sticas MY</a>
      {% if (session.get("role") or "") == "SuperAdmin" %}
        <a class="pill pill-link" href="{{ url_for('admin_menu') }}">{{ current_user }}</a>
      {% else %}
        <a class="pill pill-link" href="{{ url_for('account') }}">{{ current_user }}</a>
      {% endif %}
      <a class="btn btn-logout btn-icon" href="{{ url_for('logout') }}" aria-label="Cerrar sesi&oacute;n" title="Cerrar sesi&oacute;n">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M10 7V6a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-7a2 2 0 0 1-2-2v-1"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path d="M3 12h10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          <path d="M7 8l-4 4 4 4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </a>
    </div>
  </header>

  <main class="page page--full">
    <section class="section section--review" style="margin-top:0">
      <div class="section-title">Revisiones</div>

      <form method="get" class="actions" style="justify-content:flex-start; gap:12px; flex-wrap:wrap">
        <input type="hidden" name="page" value="1" />
        <input type="hidden" name="per_page" value="{{ per_page or 10 }}" />
        <div class="field" style="min-width:260px">
          <span>Filtrar por Revisor</span>
          <select name="revisor">
            <option value="" {% if not selected_user %}selected{% endif %}>Todos</option>
            {% for u in users %}
              <option value="{{ u.get('username','') }}" {% if selected_user == u.get('username','') %}selected{% endif %}>{{ u.get('username','') }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="field" style="min-width:240px">
          <span>Filtrar por Estado</span>
          <select name="estado">
            <option value="" {% if not selected_status %}selected{% endif %}>Todos</option>
            {% for s in (statuses or []) %}
              <option value="{{ s }}" {% if selected_status == s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="field" style="min-width:220px">
          <span>Buscar ID Correo</span>
          <input name="idcorreo" value="{{ selected_id or '' }}" placeholder="Ej: 12345" />
        </div>

        <div class="actions" style="align-items:flex-end">
          <button class="btn btn-primary" type="submit">Aplicar</button>
          <details class="dropdown">
            <summary class="btn btn-ghost">Descargar</summary>
            <div class="dropdown-menu">
              <a class="dropdown-item" href="{{ url_for('listado_download', revisor=selected_user, estado=selected_status, idcorreo=selected_id, format='csv') }}">CSV</a>
              <a class="dropdown-item" href="{{ url_for('listado_download', revisor=selected_user, estado=selected_status, idcorreo=selected_id, format='xlsx') }}">Excel</a>
            </div>
          </details>
        </div>
      </form>

      <div class="actions" style="justify-content:flex-start; gap:10px; margin-top:10px; flex-wrap:wrap">
        <div class="pill">Total: {{ total }}</div>
      </div>

      <div style="overflow:auto; margin-top:10px">
        <table class="tbl">
          <thead>
            <tr>
              <th>Fecha revisi&oacute;n</th>
              <th>Revisor</th>
              <th>ID Correo</th>
              <th>Estado</th>
              <th>Automatismo</th>
              <th>Detalle</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
              {% set rec = (r.get("_record_clean") or {}) %}
              <tr>
                <td>{{ r.get("timestamp","") }}</td>
                <td>{{ r.get("user","") }}</td>
                <td>{{ r.get("record_id","") }}</td>
                <td>{{ r.get("status","") }}</td>
                <td>{{ r.get("automatismo","") }}</td>
                <td style="min-width:340px">
                  <details>
                    <summary>Ver</summary>
                    <div class="tbl-detail">
                      <div class="actions" style="justify-content:flex-start; margin-bottom:8px">
                        <a class="btn btn-secondary btn-sm" href="{{ url_for('listado_editar', blob=r.get('_blob_name',''), next=request.full_path if request else '') }}">Editar (admin)</a>
                      </div>
                      <div class="section section--review section--compact" style="margin:0; padding:12px">
                        <div class="section-title" style="margin-bottom:10px">RevisiИn EY</div>
                        <div class="grid-5">
                          <div class="kv kv-vert"><div class="k">Estado</div><div class="v">{{ r.get("status","") }}</div></div>
                          <div class="kv kv-vert"><div class="k">Detalle KO MTM</div><div class="v">{{ r.get("ko_mym_reason","") }}</div></div>
                          <div class="kv kv-vert"><div class="k">Comentario de revisi&oacute;n</div><div class="v">{{ r.get("reviewer_note","") }}</div></div>
                          <div class="kv kv-vert"><div class="k">Nota interna</div><div class="v">{{ r.get("_internal_note_text","") }}</div></div>
                          <div class="kv kv-vert"><div class="k">Multitem&aacute;tica</div><div class="v">{{ "S&iacute;" if r.get("multitematica") else "No" }}</div></div>
                        </div>
                      </div>

                      <div class="section section--agent" style="margin-top:10px; padding:12px">
                        <div class="section-title" style="margin-bottom:10px">Feedback Agente</div>
                        <div class="grid-3">
                          <div class="kv kv-vert"><div class="k">Validado por agente</div><div class="v">{{ rec.get("Validado","") }}</div></div>
                          <div class="kv kv-vert"><div class="k">Motivo</div><div class="v">{{ rec.get("Motivo","") }}</div></div>
                          <div class="kv kv-vert"><div class="k">Comentario</div><div class="v">{{ rec.get("Comentario","") }}</div></div>
                        </div>
                      </div>

                      <div class="section section--mail" style="margin-top:10px; padding:12px">
                        <div class="section-title" style="margin-bottom:10px">Datos del correo</div>
                        <div class="grid-3">
                          <div class="kv kv-vert"><div class="k">ID Correo</div><div class="v">{{ rec.get("IdCorreo","") }}</div></div>
                          <div class="kv kv-vert"><div class="k">Asunto</div><div class="v">{{ rec.get("Subject","") }}</div></div>
                          <div class="kv kv-vert"><div class="k">Fecha</div><div class="v">{{ rec.get("@timestamp","") }}</div></div>
                        </div>
                        <div class="kv kv-vert" style="margin-top:10px"><div class="k">Correo completo</div><div class="v">{{ rec.get("Question","") }}</div></div>
                      </div>

                      <div class="section section--act" style="margin-top:10px; padding:12px">
                        <div class="section-title" style="margin-bottom:10px">ActuaciÇün MY</div>
                        <div class="grid-3">
                          <div class="kv kv-vert"><div class="k">TemÇ­tica</div><div class="v">{{ rec.get("Location","") }}</div></div>
                          <div class="kv kv-vert"><div class="k">SubtemÇ­tica</div><div class="v">{{ rec.get("Sublocation","") }}</div></div>
                          <div class="kv kv-vert"><div class="k">Automatismo</div><div class="v">{{ rec.get("Automatismo","") }}</div></div>
                        </div>
                        {% if r.get("_act_summary") or r.get("_act_proposal") %}
                          <div class="ia-grid" style="margin-top:10px">
                            <div class="kv kv-vert"><div class="k">Resumen</div><div class="v">{{ r.get("_act_summary","") }}</div></div>
                            <div class="kv kv-vert"><div class="k">Propuesta de actuaciÇün</div><div class="v">{{ r.get("_act_proposal","") }}</div></div>
                          </div>
                        {% endif %}
                        {% if r.get("_act_params") %}
                          <div class="kv kv-vert" style="margin-top:10px"><div class="k">ParÇ­metros</div><div class="v">{{ r.get("_act_params","") }}</div></div>
                        {% endif %}
                      </div>

                      {% if r.get("_otros_items") %}
                        <details style="margin-top:10px">
                          <summary>Otros</summary>
                          <div class="section" style="margin-top:8px; padding:12px">
                            <div class="ia-grid">
                              {% for k, v in (r.get("_otros_items") or []) %}
                                <div class="kv kv-vert"><div class="k">{{ k }}</div><div class="v">{{ v }}</div></div>
                              {% endfor %}
                            </div>
                          </div>
                        </details>
                      {% endif %}

                      <details style="margin-top:10px">
                        <summary>History</summary>
                        <div class="section" style="margin-top:8px; padding:12px">
                          <div class="kv-list">
                            {% for ts, u, summary in (r.get("_history_rows") or []) %}
                              <div class="kv-row kv-row-3"><div class="k">{{ ts }}</div><div class="v">{{ u }}</div><div class="v">{{ summary }}</div></div>
                            {% endfor %}
                            {% if not (r.get("_history_rows") or []) %}
                              <div class="kv-row"><div class="k">Sin cambios</div><div class="v">—</div></div>
                            {% endif %}
                          </div>
                        </div>
                      </details>

                      <details style="margin-top:10px">
                        <summary>JSON completo</summary>
                        <pre style="margin-top:8px">{{ (r.get("_record_clean") or {}) | tojson(indent=2) }}</pre>
                      </details>
                    </div>
                  </details>
                </td>
              </tr>
            {% endfor %}
            {% if not rows %}
              <tr><td colspan="6" class="tbl-empty">Sin resultados</td></tr>
            {% endif %}
          </tbody>
        </table>
        <div class="tbl-footer">Filas totales: {{ total }}</div>
      </div>

      <div class="list-footer">
        <div class="list-footer-left hidden">
          {% if page > 1 %}
            <a class="btn btn-ghost btn-sm" href="{{ url_for('listado', revisor=selected_user, estado=selected_status, idcorreo=selected_id, per_page=per_page, page=1) }}">&laquo;</a>
            <a class="btn btn-ghost btn-sm" href="{{ url_for('listado', revisor=selected_user, estado=selected_status, idcorreo=selected_id, per_page=per_page, page=page-1) }}">&lsaquo;</a>
          {% endif %}
          {% if page < total_pages %}
            <a class="btn btn-ghost btn-sm" href="{{ url_for('listado', revisor=selected_user, estado=selected_status, idcorreo=selected_id, per_page=per_page, page=page+1) }}">&rsaquo;</a>
            <a class="btn btn-ghost btn-sm" href="{{ url_for('listado', revisor=selected_user, estado=selected_status, idcorreo=selected_id, per_page=per_page, page=total_pages) }}">&raquo;</a>
          {% endif %}
        </div>
        <div class="list-footer-right">
          {% if page > 1 %}
            <a class="btn btn-ghost btn-sm" href="{{ url_for('listado', revisor=selected_user, estado=selected_status, idcorreo=selected_id, per_page=per_page, page=1) }}">&laquo;</a>
            <a class="btn btn-ghost btn-sm" href="{{ url_for('listado', revisor=selected_user, estado=selected_status, idcorreo=selected_id, per_page=per_page, page=page-1) }}">&lsaquo;</a>
          {% endif %}
          <div class="pill pill-sm">PÇ­gina {{ page }} / {{ total_pages }}</div>
          {% if page < total_pages %}
            <a class="btn btn-ghost btn-sm" href="{{ url_for('listado', revisor=selected_user, estado=selected_status, idcorreo=selected_id, per_page=per_page, page=page+1) }}">&rsaquo;</a>
            <a class="btn btn-ghost btn-sm" href="{{ url_for('listado', revisor=selected_user, estado=selected_status, idcorreo=selected_id, per_page=per_page, page=total_pages) }}">&raquo;</a>
          {% endif %}
          <form method="get" class="list-footer-form">
            <input type="hidden" name="page" value="1" />
            <input type="hidden" name="revisor" value="{{ selected_user or '' }}" />
            <input type="hidden" name="estado" value="{{ selected_status or '' }}" />
            <input type="hidden" name="idcorreo" value="{{ selected_id or '' }}" />
            <select name="per_page" class="select-compact" onchange="this.form.submit()" aria-label="Filas por pÇ­gina">
              {% for opt in [10,25,50] %}
                <option value="{{ opt }}" {% if per_page == opt %}selected{% endif %}>{{ opt }}</option>
              {% endfor %}
            </select>
          </form>
        </div>
      </div>
    </section>
  </main>
{% endblock %}
