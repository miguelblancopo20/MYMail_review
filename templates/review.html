{% extends "base.html" %}
{% block body %}
  <header class="topbar">
    <div class="topbar-left">
      <img class="topbar-logo" alt="EY logo" src="{{ url_for('static', filename='img/ey.png') }}" onerror="this.style.display='none'" />
      <div class="topbar-title">Revisor de Mayordomo Mail <span class="version-badge">v{{ app_version }}</span></div>
    </div>
    <div class="topbar-fields">
      <div class="topbar-field"><span>Fecha</span><strong>{{ record.get("@timestamp","") }}</strong></div>
      <div class="topbar-field">
        <span>ID Correo</span>
        <div class="topbar-idline">
          <strong>{{ record.get("IdCorreo","") }}</strong>
          {% if not edit_mode %}
            <span class="topbar-timer" id="lockTimer" data-lock-until-ms="{{ lock_until_ms or '' }}">--:--</span>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="topbar-right">
      {% if edit_mode %}
        <a class="btn btn-ghost btn-sm btn-nav" href="{{ back_url or url_for('listado') }}">Volver</a>
        <div class="pill">Editando</div>
      {% else %}
        <div class="pill">Pendientes: {{ pending }}</div>
      {% endif %}
      {% if can_stats %}
        <a class="btn btn-ghost btn-sm btn-nav" href="{{ url_for('listado') }}">Listado</a>
        <a class="btn btn-ghost btn-sm btn-nav" href="{{ url_for('pendientes') }}">Pendientes</a>
        <a class="btn btn-ghost btn-sm btn-nav" href="{{ url_for('review') }}">Revisi&oacute;n</a>
        <a class="btn btn-ghost btn-sm btn-nav" href="{{ url_for('stats') }}">Estad&iacute;sticas</a>
        <a class="btn btn-ghost btn-sm btn-nav" href="{{ url_for('stats_my') }}">Estad&iacute;sticas MY</a>
      {% else %}
        <a class="btn btn-ghost btn-sm btn-nav" href="{{ url_for('pendientes') }}">Pendientes</a>
        <a class="btn btn-ghost btn-sm btn-nav" href="{{ url_for('review') }}">Revisi&oacute;n</a>
      {% endif %}
      {% if (session.get("role") or "") == "Administrador" %}
        <a class="pill pill-link" href="{{ url_for('admin_menu') }}">{{ current_user }}</a>
      {% else %}
        <a class="pill pill-link" href="{{ url_for('account') }}">{{ current_user }}</a>
      {% endif %}
      <a class="btn btn-logout btn-icon" href="{{ url_for('logout') }}" aria-label="Cerrar sesión" title="Cerrar sesión">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M10 7V6a2 2 0 0 1 2-2h7a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-7a2 2 0 0 1-2-2v-1"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <path d="M3 12h10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          <path d="M7 8l-4 4 4 4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </a>
    </div>
  </header>

  <main class="page page--full">
    {% if not edit_mode %}
      <div
        id="lock-heartbeat"
        class="hidden"
        data-heartbeat-url="{{ url_for('heartbeat') }}"
        data-refresh-url="{{ url_for('refresh') }}"
        data-error="{{ (error or '') | e }}"
      ></div>
    {% endif %}
    <div class="layout">
      <div class="layout-left">
        <section class="section section--mail">
          <div class="section-title">Datos del correo</div>

          <div class="row-2">
            <div class="field readonly">
              <div class="field-head">
                <div class="field-label">Asunto</div>
              </div>
              <input id="subject" value="{{ record.get('Subject','') }}" readonly />
            </div>

            <div class="field readonly">
              <div class="field-head">
                <div class="field-label">From</div>
              </div>
              <input value="{{ mail_meta.get('From') or '' }}" readonly />
            </div>
          </div>

          <div class="field readonly">
            <div class="field-head">
              <div class="field-label">Correo completo</div>
            </div>
            <textarea id="question" class="textarea-mail" readonly>{{ record.get("Question","") }}</textarea>
          </div>
        </section>

        <section class="section section--act">
          <div class="section-title">Actuación MY</div>

          <div class="meta-row" title="Temática · Subtemática · Acción · Automatismo · Ficha">
            <div class="meta-item"><span>Temática</span><strong>{{ record.get("Location","") or "—" }}</strong></div>
            <div class="meta-item"><span>Subtemática</span><strong>{{ record.get("Sublocation","") or "—" }}</strong></div>
            <div class="meta-item"><span>Acción</span><strong>{{ mail_meta.get("Acción") or "—" }}</strong></div>
            <div class="meta-item"><span>Automatismo</span><strong>{{ record.get("Automatismo","") or "—" }}</strong></div>
            <div class="meta-item"><span>Ficha</span><strong>{{ mail_meta.get("Ficha") or "—" }}</strong></div>
          </div>

          {% if act_summary %}
            <div class="field readonly">
              <div class="field-head"><div class="field-label">Resumen</div></div>
              <textarea class="textarea-half" readonly>{{ act_summary }}</textarea>
            </div>
          {% endif %}

          {% if act_proposal %}
            <div class="field readonly">
              <div class="field-head"><div class="field-label">Propuesta de actuación</div></div>
              <textarea class="textarea-half" readonly>{{ act_proposal }}</textarea>
            </div>
          {% endif %}

          {% if act_params %}
            <div class="field readonly">
              <div class="field-head"><div class="field-label">Parámetros</div></div>
              <textarea class="textarea-params" readonly>{{ act_params }}</textarea>
            </div>
          {% endif %}

          {% if act_items %}
            <div class="ia-grid">
              {% for key, value in act_items %}
                <div class="field readonly ia-item">
                  <div class="field-head">
                    <div class="field-label">{{ key }}</div>
                  </div>
                  <textarea class="textarea-ia" readonly>{{ value }}</textarea>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </section>
      </div>

      <div class="layout-rightcol">
        <section class="section section--agent">
          <div class="section-title">Feedback Agente</div>
          <div class="stack">
            <div class="kv kv-vert"><div class="k">Validado por agente</div><div class="v">{{ record.get("Validado","") }}</div></div>
            <div class="kv kv-vert"><div class="k">Motivo</div><div class="v">{{ record.get("Motivo","") }}</div></div>
            <div class="kv kv-vert"><div class="k">Comentario</div><div class="v">{{ record.get("Comentario","") }}</div></div>
          </div>
        </section>

        <section class="section section--review rightcol-review">
          <div class="section-title">Revisión EY</div>

          <form method="post" action="{{ form_action or url_for('action') }}" class="stack" data-overlay data-edit-mode="{{ 1 if edit_mode else 0 }}" id="reviewForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            {% if edit_mode %}
              <input type="hidden" name="edit_blob" value="{{ edit_blob or '' }}" />
              <input type="hidden" name="edit_original_user" value="{{ edit_original_user or '' }}" />
              <input type="hidden" name="back_url" value="{{ back_url or '' }}" />
            {% endif %}
            <div class="field">
              <span>Estado revisión <span class="req-marker">*</span></span>
              <select name="status" id="statusSelect">
                {% for opt in ["Pendiente","OK","KO MYM","KO AGENTE","DUDA","FDS"] %}
                  <option value="{{ opt }}" {% if opt == (initial_status or "Pendiente") %}selected{% endif %}>{{ opt }}</option>
                {% endfor %}
              </select>
            </div>
            <label class="checkbox">
              <input type="checkbox" name="multitematica" value="1" {% if initial_multitematica %}checked{% endif %} />
              <span>Multitematica (opcional)</span>
            </label>
            <div class="field hidden" id="koMymReasonWrap">
              <span>Detalle KO MYM <span class="req-marker" id="reqKoMym">*</span></span>
              <select name="ko_mym_reason" id="koMymReason">
                <option value="" {% if not (initial_ko_mym_reason or '') %}selected{% endif %}>Pendiente</option>
                {% for opt in ["KO TEMATICA","KO SUBTEMATICA","KO PARAMETROS","KO TEMÁTICA Y PARAMETROS","KO SUBTEMÁTICA Y PARAMETROS","OTRO"] %}
                  <option value="{{ opt }}" {% if opt == (initial_ko_mym_reason or '') %}selected{% endif %}>{{ opt }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="field">
              <span>Comentario de revisión <span class="req-marker hidden" id="reqNote">*</span></span>
              <input id="reviewerNote" name="reviewer_note" placeholder="Describe el ajuste a realizar" value="{{ initial_reviewer_note or '' }}" />
            </div>
            <div class="field">
              <span>Nota interna (opcional)</span>
              <input name="internal_note" placeholder="Observaciones operativas o pasos siguientes." value="{{ initial_internal_note or '' }}" />
            </div>
            <input type="hidden" name="elapsed_seconds" id="elapsedSeconds" value="" />
            <div class="actions actions-bottom actions-center">
              <button class="btn btn-primary" type="submit" name="action" value="save" id="btnSave" disabled data-overlay-message="{{ 'Guardando cambios...' if edit_mode else 'Guardando revisión...' }}">{{ 'Guardar cambios' if edit_mode else 'Guardar' }}</button>
              {% if not edit_mode %}
                <button class="btn btn-secondary" type="submit" name="action" value="skip" id="btnSkip" data-overlay-message="Guardando descarte...">Saltar</button>
              {% endif %}
            </div>
          </form>
        </section>
        {% if can_ai %}
          <section class="section section--act">
            <div class="section-title">Utiliza la IA</div>
            <div class="actions" style="justify-content:flex-start">
              <button type="button" class="btn btn-primary" id="btnAiTematica" data-ai-url="{{ url_for('ai_tematica') }}">Sugerir temática</button>
            </div>
            <div class="kv kv-vert" style="margin-top:10px">
              <div class="k">Sugerencia</div>
              <div class="v" id="aiTematicaResult" style="min-height:52px"></div>
            </div>
          </section>
        {% endif %}
      </div>
    </div>
  </main>
{% endblock %}
